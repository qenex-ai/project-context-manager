# Index JSON Schema Specification

## Overview

Complete specification for `.claude/.project-index.json` structure. This schema defines the format for project metadata generated by the indexing process.

## Schema Version

**Current version:** 1.0.0
**Format:** JSON
**Location:** `.claude/.project-index.json` in project root

## Root Structure

```json
{
  "schema_version": "1.0.0",
  "indexed_at": "ISO8601 timestamp",
  "project_root": "absolute path",
  "languages": {},
  "dependencies": {},
  "key_files": {},
  "structure": {},
  "git": {},
  "metadata": {}
}
```

## Field Specifications

### schema_version

**Type:** String
**Required:** Yes
**Format:** Semantic versioning (MAJOR.MINOR.PATCH)

**Purpose:** Track index format version for compatibility

**Example:**
```json
"schema_version": "1.0.0"
```

### indexed_at

**Type:** String
**Required:** Yes
**Format:** ISO 8601 timestamp with timezone

**Purpose:** Record when index was generated

**Example:**
```json
"indexed_at": "2026-01-22T15:30:00Z"
```

### project_root

**Type:** String
**Required:** Yes
**Format:** Absolute filesystem path

**Purpose:** Identify project location

**Example:**
```json
"project_root": "/home/ubuntu/qenex"
```

### languages

**Type:** Object
**Required:** Yes
**Structure:** Language name → Language details

**Language object:**
```json
{
  "LanguageName": {
    "file_count": 145,
    "percentage": 45.2,
    "primary": true,
    "manifests": ["requirements.txt", "setup.py"],
    "entry_points": ["src/main.py", "app.py"]
  }
}
```

**Field descriptions:**
- `file_count` (integer): Number of source files
- `percentage` (float): Percentage of total project files
- `primary` (boolean): True if this is the main language
- `manifests` (array): Package manager files found
- `entry_points` (array): Main entry point files

**Full example:**
```json
"languages": {
  "Python": {
    "file_count": 145,
    "percentage": 45.2,
    "primary": true,
    "manifests": ["requirements.txt", "pyproject.toml"],
    "entry_points": ["src/main.py", "manage.py"]
  },
  "Rust": {
    "file_count": 89,
    "percentage": 27.8,
    "primary": false,
    "manifests": ["Cargo.toml", "Cargo.lock"],
    "entry_points": ["src/main.rs", "src/lib.rs"]
  },
  "Go": {
    "file_count": 67,
    "percentage": 20.9,
    "primary": false,
    "manifests": ["go.mod", "go.sum"],
    "entry_points": ["cmd/server/main.go"]
  }
}
```

### dependencies

**Type:** Object
**Required:** Yes
**Structure:** Language name → Dependency list or object

**Simple format (just names):**
```json
"dependencies": {
  "Python": ["requests", "numpy", "pandas"],
  "Rust": ["tokio", "serde", "anyhow"],
  "Go": ["github.com/gin-gonic/gin"]
}
```

**Detailed format (with classification):**
```json
"dependencies": {
  "Python": {
    "production": ["requests", "numpy"],
    "development": ["pytest", "black"],
    "total": 4
  },
  "Rust": {
    "dependencies": ["tokio", "serde"],
    "dev_dependencies": ["criterion"],
    "build_dependencies": ["cc"],
    "total": 4
  },
  "JavaScript": {
    "dependencies": ["react", "express"],
    "devDependencies": ["jest", "webpack"],
    "peerDependencies": ["react-dom"],
    "total": 5
  }
}
```

**Total count (optional):**
```json
"dependencies": {
  "Python": ["requests", "numpy"],
  "Rust": ["tokio", "serde"],
  "_total": 4
}
```

### key_files

**Type:** Object
**Required:** Yes
**Structure:** Category → File list

**Categories:**
- `entry_points`: Main executable or library entry files
- `configs`: Configuration files
- `documentation`: README, docs, guides
- `tests`: Test directories and files
- `build`: Build scripts, Dockerfiles, CI configs

**Example:**
```json
"key_files": {
  "entry_points": [
    "src/main.rs",
    "scripts/server.py",
    "cmd/api/main.go"
  ],
  "configs": [
    ".env.example",
    "config/production.yaml",
    "docker-compose.yml"
  ],
  "documentation": [
    "README.md",
    "docs/architecture.md",
    "CLAUDE.md"
  ],
  "tests": [
    "tests/",
    "src/lib_test.rs",
    "cmd/api/main_test.go"
  ],
  "build": [
    "Dockerfile",
    ".github/workflows/ci.yml",
    "Makefile"
  ]
}
```

### structure

**Type:** Object
**Required:** Yes
**Structure:** Project organization metadata

**Fields:**
- `architecture` (string): Project pattern (monolith, monorepo, microservices, library)
- `root_dirs` (array): Top-level directories
- `depth` (integer): Maximum directory depth
- `total_files` (integer): Total file count
- `total_size_mb` (float): Total size in megabytes
- `ignored_dirs` (array): Directories excluded from scan

**Example:**
```json
"structure": {
  "architecture": "monorepo",
  "root_dirs": ["src", "tests", "docs", "config", "scripts"],
  "depth": 5,
  "total_files": 320,
  "total_size_mb": 12.4,
  "ignored_dirs": ["node_modules", "target", "venv", "__pycache__"]
}
```

**Architecture types:**
- `monolith`: Single language, standard structure
- `monorepo`: Multiple projects, shared workspace
- `microservices`: Multiple independent services
- `library`: Reusable package/library

### git

**Type:** Object
**Required:** No (omit if not a git repository)
**Structure:** Git repository metadata

**Fields:**
- `branch` (string): Current branch name
- `has_changes` (boolean): Uncommitted changes present
- `last_commit` (string): Short commit hash
- `remote` (string): Remote URL (if configured)
- `tags` (array): Recent tags

**Example:**
```json
"git": {
  "branch": "master",
  "has_changes": true,
  "last_commit": "a34a001",
  "remote": "git@github.com:user/repo.git",
  "tags": ["v1.0.0", "v0.9.0"]
}
```

### metadata

**Type:** Object
**Required:** No
**Structure:** Additional project-specific metadata

**Optional fields:**
- `name` (string): Project name
- `description` (string): Project description
- `version` (string): Project version
- `license` (string): License identifier
- `authors` (array): Author names/emails
- `homepage` (string): Project homepage URL

**Example:**
```json
"metadata": {
  "name": "qenex-trading-platform",
  "description": "High-frequency trading system",
  "version": "2.1.0",
  "license": "MIT",
  "authors": ["QENEX Team <ceo@qenex.ai>"],
  "homepage": "https://qenex.ai"
}
```

## Complete Example

### Polyglot Project

```json
{
  "schema_version": "1.0.0",
  "indexed_at": "2026-01-22T15:30:00Z",
  "project_root": "/home/ubuntu/qenex",
  "languages": {
    "Python": {
      "file_count": 145,
      "percentage": 45.2,
      "primary": true,
      "manifests": ["requirements.txt", "pyproject.toml"],
      "entry_points": ["src/main.py", "manage.py"]
    },
    "Rust": {
      "file_count": 89,
      "percentage": 27.8,
      "primary": false,
      "manifests": ["Cargo.toml", "Cargo.lock"],
      "entry_points": ["src/main.rs", "src/lib.rs"]
    },
    "Go": {
      "file_count": 67,
      "percentage": 20.9,
      "primary": false,
      "manifests": ["go.mod", "go.sum"],
      "entry_points": ["cmd/server/main.go"]
    },
    "JavaScript": {
      "file_count": 19,
      "percentage": 5.9,
      "primary": false,
      "manifests": ["package.json"],
      "entry_points": ["index.js"]
    }
  },
  "dependencies": {
    "Python": {
      "production": ["requests", "numpy", "pandas", "fastapi"],
      "development": ["pytest", "black", "ruff"],
      "total": 7
    },
    "Rust": {
      "dependencies": ["tokio", "serde", "anyhow", "reqwest"],
      "dev_dependencies": ["criterion"],
      "total": 5
    },
    "Go": {
      "production": ["github.com/gin-gonic/gin", "github.com/sirupsen/logrus"],
      "total": 2
    },
    "JavaScript": {
      "dependencies": ["express"],
      "devDependencies": ["jest", "webpack"],
      "total": 3
    },
    "_total": 17
  },
  "key_files": {
    "entry_points": [
      "src/main.rs",
      "src/main.py",
      "cmd/server/main.go",
      "index.js"
    ],
    "configs": [
      ".env.example",
      "config/production.yaml",
      "docker-compose.yml",
      "Caddyfile"
    ],
    "documentation": [
      "README.md",
      "docs/architecture.md",
      "docs/api.md",
      "CLAUDE.md"
    ],
    "tests": [
      "tests/",
      "src/lib_test.rs",
      "cmd/server/main_test.go"
    ],
    "build": [
      "Dockerfile",
      ".github/workflows/ci.yml",
      "Makefile",
      "build.sh"
    ]
  },
  "structure": {
    "architecture": "monorepo",
    "root_dirs": ["src", "cmd", "tests", "docs", "config", "scripts"],
    "depth": 6,
    "total_files": 320,
    "total_size_mb": 12.4,
    "ignored_dirs": ["node_modules", "target", "venv", "__pycache__", "dist"]
  },
  "git": {
    "branch": "master",
    "has_changes": true,
    "last_commit": "a34a001",
    "remote": "git@github.com:qenex/platform.git",
    "tags": ["v2.1.0", "v2.0.0"]
  },
  "metadata": {
    "name": "qenex-trading-platform",
    "description": "High-frequency trading system with 888 autonomous agents",
    "version": "2.1.0",
    "license": "MIT",
    "authors": ["QENEX Team <ceo@qenex.ai>"],
    "homepage": "https://qenex.ai"
  }
}
```

### Single-Language Project

```json
{
  "schema_version": "1.0.0",
  "indexed_at": "2026-01-22T10:15:00Z",
  "project_root": "/home/user/my-rust-app",
  "languages": {
    "Rust": {
      "file_count": 42,
      "percentage": 100.0,
      "primary": true,
      "manifests": ["Cargo.toml", "Cargo.lock"],
      "entry_points": ["src/main.rs"]
    }
  },
  "dependencies": {
    "Rust": {
      "dependencies": ["tokio", "serde", "anyhow"],
      "dev_dependencies": ["criterion"],
      "total": 4
    }
  },
  "key_files": {
    "entry_points": ["src/main.rs"],
    "configs": [".env.example"],
    "documentation": ["README.md"],
    "tests": ["tests/integration_test.rs"],
    "build": [".github/workflows/ci.yml"]
  },
  "structure": {
    "architecture": "library",
    "root_dirs": ["src", "tests"],
    "depth": 2,
    "total_files": 42,
    "total_size_mb": 0.8,
    "ignored_dirs": ["target"]
  },
  "git": {
    "branch": "main",
    "has_changes": false,
    "last_commit": "b12c456"
  }
}
```

## Validation Rules

### Required Fields

All index files MUST include:
- `schema_version`
- `indexed_at`
- `project_root`
- `languages` (even if empty: `{}`)
- `dependencies` (even if empty: `{}`)
- `key_files` (even if empty: `{}`)
- `structure`

### Data Types

Enforce strict typing:
- Timestamps: ISO 8601 strings
- Counts: Non-negative integers
- Percentages: Floats 0.0-100.0
- Booleans: `true` or `false` (not strings)
- Arrays: Can be empty `[]`
- Objects: Can be empty `{}`

### Percentage Validation

Language percentages should sum to ~100.0 (allow 0.1 tolerance for rounding):

```python
total = sum(lang["percentage"] for lang in languages.values())
assert 99.9 <= total <= 100.1, f"Percentages sum to {total}, expected ~100"
```

### Path Validation

All paths should be:
- Absolute (for `project_root`)
- Relative to project root (for files in `key_files`)
- No `..` traversal
- Forward slashes (even on Windows)

## Versioning and Migration

### Schema Version Changes

**Minor version bump (1.0 → 1.1):**
- Add optional fields
- Add new categories to existing objects
- Backward compatible

**Major version bump (1.0 → 2.0):**
- Remove or rename required fields
- Change data types
- Restructure schema
- Breaking changes

### Migration Strategy

When schema version increases:

```python
def migrate_index(index_data):
    current_version = index_data.get("schema_version", "1.0.0")

    if current_version == "1.0.0" and TARGET_VERSION == "1.1.0":
        # Add new optional fields with defaults
        index_data.setdefault("metadata", {})
        index_data["schema_version"] = "1.1.0"

    return index_data
```

## Performance Considerations

### Size Limits

Target index file size: <50 KB
Maximum reasonable size: 500 KB

**If exceeding limits:**
- Truncate dependency lists (keep top N most important)
- Summarize key_files (directories instead of all files)
- Omit optional metadata

### Generation Time

Target: <5 seconds for typical projects
Maximum: 60 seconds for huge repos

**Optimization:**
- Cache unchanged sections
- Parallel language detection
- Skip deep ignored directories early

## Usage Examples

### Read Index in Commands

```bash
# Check if index exists
if [ ! -f ".claude/.project-index.json" ]; then
  echo "No index found. Run: /index-project"
  exit 1
fi

# Extract primary language
PRIMARY=$(jq -r '.languages | to_entries[] | select(.value.primary == true) | .key' \
  .claude/.project-index.json)

echo "Primary language: $PRIMARY"

# Get total file count
TOTAL_FILES=$(jq -r '.structure.total_files' .claude/.project-index.json)
echo "Total files: $TOTAL_FILES"
```

### Update Index Incrementally

```bash
# Read existing index
INDEX=$(cat .claude/.project-index.json)

# Update timestamp only
echo "$INDEX" | \
  jq '.indexed_at = "2026-01-22T16:00:00Z"' > \
  .claude/.project-index.json.tmp

mv .claude/.project-index.json.tmp .claude/.project-index.json
```

### Validate Index

```bash
# Check required fields present
REQUIRED_FIELDS=("schema_version" "indexed_at" "project_root" "languages" "dependencies" "key_files" "structure")

for field in "${REQUIRED_FIELDS[@]}"; do
  if ! jq -e ".$field" .claude/.project-index.json >/dev/null 2>&1; then
    echo "Error: Missing required field: $field"
    exit 1
  fi
done

echo "Index validation passed"
```
