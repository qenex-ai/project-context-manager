---
name: store-credential
description: Securely store credentials in system keychain
version: 1.0.0

frontmatter:
  usage: |
    /store-credential --name <name> --type <type> [--value <value>] [--file <path>] [--global]
  
  examples:
    - /store-credential --name mev-private-key --type private-key
    - /store-credential --name github-api --type api-key --value "ghp_..."
    - /store-credential --name deploy-key --type ssh-key --file ~/.ssh/deploy_key
    - /store-credential --name api-key --type api-key --global

  arguments:
    - name: --name
      description: Credential identifier
      required: true
    - name: --type
      description: Credential type (private-key, api-key, ssh-key, oauth-token, database)
      required: true
    - name: --value
      description: Credential value (for simple strings)
      required: false
    - name: --file
      description: Read credential from file
      required: false
    - name: --global
      description: Store globally (default: project-scoped)
      required: false

script: |
  #!/bin/bash
  set -e

  # Parse arguments
  NAME=""
  TYPE=""
  VALUE=""
  FILE=""
  GLOBAL="false"

  while [[ $# -gt 0 ]]; do
    case $1 in
      --name)
        NAME="$2"
        shift 2
        ;;
      --type)
        TYPE="$2"
        shift 2
        ;;
      --value)
        VALUE="$2"
        shift 2
        ;;
      --file)
        FILE="$2"
        shift 2
        ;;
      --global)
        GLOBAL="true"
        shift
        ;;
      *)
        echo "Unknown argument: $1"
        exit 1
        ;;
    esac
  done

  # Validate required arguments
  if [ -z "$NAME" ]; then
    echo "Error: --name is required"
    exit 1
  fi

  if [ -z "$TYPE" ]; then
    echo "Error: --type is required"
    exit 1
  fi

  # Get project context
  PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
  PROJECT_NAME=$(basename "$PROJECT_ROOT")

  # Build service name
  if [ "$GLOBAL" = "true" ]; then
    SERVICE="claude-code:global:${NAME}"
  else
    SERVICE="claude-code:${PROJECT_NAME}:${NAME}"
  fi

  # Get credential value
  if [ -n "$FILE" ]; then
    if [ ! -f "$FILE" ]; then
      echo "Error: File not found: $FILE"
      exit 1
    fi
    CREDENTIAL_VALUE=$(cat "$FILE")
  elif [ -n "$VALUE" ]; then
    CREDENTIAL_VALUE="$VALUE"
  else
    echo "Error: Either --value or --file must be provided"
    exit 1
  fi

  # Store credential
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  bash "$SCRIPT_DIR/../scripts/credentials/keychain-wrapper.sh" store "$SERVICE" "$TYPE" "$CREDENTIAL_VALUE"

  # Verify storage
  STORED=$(bash "$SCRIPT_DIR/../scripts/credentials/keychain-wrapper.sh" list "claude-code:${PROJECT_NAME}" | grep -c "$NAME" || echo "0")
  
  if [ "$STORED" -gt 0 ]; then
    echo "✓ Credential '$NAME' stored successfully"
    echo "  Scope: $([ "$GLOBAL" = "true" ] && echo "Global" || echo "Project: $PROJECT_NAME")"
    echo "  Type: $TYPE"
  else
    echo "✗ Failed to store credential"
    exit 1
  fi

  # Add to .gitignore
  if [ "$GLOBAL" != "true" ]; then
    if [ -f "$PROJECT_ROOT/.gitignore" ]; then
      if ! grep -q ".credentials.enc" "$PROJECT_ROOT/.gitignore" 2>/dev/null; then
        echo ".credentials.enc" >> "$PROJECT_ROOT/.gitignore"
        echo "*.vault" >> "$PROJECT_ROOT/.gitignore"
        echo "✓ Added credential patterns to .gitignore"
      fi
    fi
  fi
